{% extends "base.html" %}
{% block content %}
<div class="container mt-4">

  <!-- Program Completion Progress -->
  <div class="card shadow mb-4">
    <div class="card-body">
      <h5 class="fw-bold">üìÖ Program Completion</h5>
      <div class="progress" style="height: 25px;">
        <div class="progress-bar bg-success fw-bold"
             role="progressbar"
             style="width: {{ completion_pct }}%;"
             aria-valuenow="{{ completion_pct }}"
             aria-valuemin="0"
             aria-valuemax="100">
          {{ completion_pct }}%
        </div>
      </div>
      <p class="mt-2 mb-0 text-muted">
        ‚úÖ Days Completed: {{ days_passed }} / {{ total_days }}
      </p>
      <p class="mb-0 text-muted">
        üî• Current Streak: {{ streak }} days
      </p>
      <p class="mb-0 text-muted">
        üèÜ Best Score: {{ best_score }} | Total Score: {{ overall_score }}
      </p>
      <p class="mb-0 text-muted">
        ‚≠ê Best Activity: {{ best_activity or "N/A" }} |
        ‚ö†Ô∏è Weakest Activity: {{ worst_activity or "N/A" }}
      </p>
    </div>
  </div>

 

  <!-- Score Trend Section -->
  <div class="card shadow mb-4">
    <div class="card-body">
      <h5 class="fw-bold">üìà Progress Trends</h5>

      <!-- Dropdown -->
      <select id="trendSelector" class="form-select mb-3">
        <option value="overall">Overall Score</option>
        {% for ua in activities %}
          <option value="activity_{{ ua.activity.id }}">{{ ua.activity.name }}</option>
        {% endfor %}
      </select>

      <!-- Chart -->
      <canvas id="trendChart" height="100"></canvas>
    </div>
  </div>

  <!-- Accordion Wrapper -->
  <div class="accordion shadow" id="dashboardAccordion">

    <!-- Daily Logger Accordion -->
    <div class="accordion-item">
      <h2 class="accordion-header" id="headingLog">
        <button class="accordion-button fw-bold" type="button" data-bs-toggle="collapse"
                data-bs-target="#collapseLog" aria-expanded="true" aria-controls="collapseLog">
          üìù Daily Log
        </button>
      </h2>
      <div id="collapseLog" class="accordion-collapse collapse show"
           aria-labelledby="headingLog" data-bs-parent="#dashboardAccordion">
        <div class="accordion-body">

          <form method="POST" action="{{ url_for('dashboard') }}">
            <!-- Date Selector -->
            <div class="mb-3">
              <label for="log_date" class="form-label fw-bold">Log Date</label>
              <input type="date" id="log_date" name="log_date"
                     class="form-control" value="{{ today }}">
            </div>

            <!-- Activities -->
            {% for ua in activities %}
            <div class="card mb-3 border-primary">
              <div class="card-body">
                <h5 class="card-title">{{ ua.activity.name }}</h5>

                <div class="btn-group d-flex" role="group">
                  <input type="radio" class="btn-check" name="activity_{{ ua.activity.id }}"
                         value="not_done" id="notdone_{{ ua.activity.id }}" checked>
                  <label class="btn btn-outline-danger flex-fill"
                         for="notdone_{{ ua.activity.id }}">‚ùå Not Done</label>

                  <input type="radio" class="btn-check" name="activity_{{ ua.activity.id }}"
                         value="L1" id="L1_{{ ua.activity.id }}">
                  <label class="btn btn-outline-success flex-fill"
                         for="L1_{{ ua.activity.id }}">L1: {{ ua.activity.level1 }}</label>

                  <input type="radio" class="btn-check" name="activity_{{ ua.activity.id }}"
                         value="L2" id="L2_{{ ua.activity.id }}">
                  <label class="btn btn-outline-primary flex-fill"
                         for="L2_{{ ua.activity.id }}">L2: {{ ua.activity.level2 }}</label>

                  <input type="radio" class="btn-check" name="activity_{{ ua.activity.id }}"
                         value="L3" id="L3_{{ ua.activity.id }}">
                  <label class="btn btn-outline-dark flex-fill"
                         for="L3_{{ ua.activity.id }}">L3: {{ ua.activity.level3 }}</label>
                </div>
              </div>
            </div>
            {% endfor %}

            <button type="submit" class="btn btn-lg btn-success w-100 mt-3">üíæ Save Log</button>
          </form>

        </div>
      </div>
    </div>

    <!-- Daily Summary Accordion -->
    <div class="accordion-item">
      <h2 class="accordion-header" id="headingSummary">
        <button class="accordion-button collapsed fw-bold" type="button"
                data-bs-toggle="collapse" data-bs-target="#collapseSummary"
                aria-expanded="false" aria-controls="collapseSummary">
          üìä View Daily Summary
        </button>
      </h2>
      <div id="collapseSummary" class="accordion-collapse collapse"
           aria-labelledby="headingSummary" data-bs-parent="#dashboardAccordion">
        <div class="accordion-body">
          <table class="table table-striped table-hover">
            <thead class="table-dark">
              <tr>
                <th>Date</th>
                {% for ua in activities %}
                  <th>{{ ua.activity.name }}</th>
                {% endfor %}
              </tr>
            </thead>
            <tbody>
              {% for log_date, logs in summary.items() %}
              <tr>
                <td>{{ log_date }}</td>
                {% for ua in activities %}
                  <td>
                    {% set status = logs.get(ua.activity.id, "Not Logged") %}
                    {% if status == "not_done" %}
                      <span class="badge bg-danger">Not Done</span>
                    {% elif status == "L1" %}
                      <span class="badge bg-success">Beginner (L1)</span>
                    {% elif status == "L2" %}
                      <span class="badge bg-primary">Intermediate (L2)</span>
                    {% elif status == "L3" %}
                      <span class="badge bg-dark">Extensive (L3)</span>
                    {% else %}
                      <span class="badge bg-secondary">Not Logged</span>
                    {% endif %}
                  </td>
                {% endfor %}
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const ctx = document.getElementById('trendChart').getContext('2d');

  // Data from Flask
  const trendData = {{ trend_data|tojson }};

  let chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: trendData.dates,
      datasets: [{
        label: 'Overall Score',
        data: trendData.overall,
        borderColor: 'green',
        backgroundColor: 'rgba(0,128,0,0.2)',
        fill: true
      }]
    }
  });

  document.getElementById('trendSelector').addEventListener('change', function() {
    const selected = this.value;
    chart.data.datasets[0].label = selected === 'overall' ? 'Overall Score' : this.options[this.selectedIndex].text;
    chart.data.datasets[0].data = trendData[selected];
    chart.update();
  });
</script>
{% endblock %}
